# =============================================================================
# ExternalSecret - ArgoCD Google OAuth Credentials (Dex SSO)
# =============================================================================
# Dex는 $dex.google.clientID 형식으로 argocd-secret에서 값을 참조
# 따라서 argocd-secret에 Merge해야 함 (별도 Secret 사용 불가)
#
# AWS Secrets Manager에 저장:
#   wealist/prod/oauth/argocd:  (ArgoCD 전용, 앱용 google과 별도)
#     client_id: "xxx.apps.googleusercontent.com"
#     client_secret: "GOCSPX-xxx"
#
# Google Cloud Console에서 OAuth 클라이언트 생성 시:
#   Redirect URI: https://argocd.wealist.co.kr/api/dex/callback

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-oauth-secret
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    # Dex는 argocd-secret에서만 $variable 참조 가능
    name: argocd-secret
    creationPolicy: Merge  # 기존 Secret에 키 추가

  data:
    # Dex가 $dex.google.clientID 형식으로 참조
    - secretKey: dex.google.clientID
      remoteRef:
        key: "wealist/prod/oauth/argocd"
        property: client_id

    - secretKey: dex.google.clientSecret
      remoteRef:
        key: "wealist/prod/oauth/argocd"
        property: client_secret
