# .github/workflows/ci-build-images.yml
name: Build and Push Images to GHCR

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to build (comma-separated, e.g., user-service,board-service). Leave empty for all services.'
        required: false
        type: string
      skip_gitops:
        description: 'Skip GitOps update trigger'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
      branch: ${{ steps.branch.outputs.name }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get branch name
        id: branch
        run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
      
      # Push ì´ë²¤íŠ¸: ìžë™ ê°ì§€
      - uses: dorny/paths-filter@v2
        if: github.event_name == 'push'
        id: filter
        with:
          filters: |
            auth-service:
              - 'services/auth-service/**'
            board-service:
              - 'services/board-service/**'
            chat-service:
              - 'services/chat-service/**'
            noti-service:
              - 'services/noti-service/**'
            storage-service:
              - 'services/storage-service/**'
            user-service:
              - 'services/user-service/**'
            video-service:
              - 'services/video-service/**'
      
      # ìˆ˜ë™ ì‹¤í–‰ ë˜ëŠ” ìžë™ ê°ì§€ ê²°ê³¼ ì„¤ì •
      - name: Set services to build
        id: set-services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.services }}" ]; then
              SERVICES=$(echo '${{ github.event.inputs.services }}' | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";""))')
              echo "Manual trigger with services: ${SERVICES}"
            else
              SERVICES='["auth-service","board-service","chat-service","noti-service","storage-service","user-service","video-service"]'
              echo "Manual trigger: building all services"
            fi
          else
            SERVICES='${{ steps.filter.outputs.changes }}'
            echo "Auto-detected services: ${SERVICES}"
          fi
          
          echo "services=${SERVICES}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.services != '[]' && needs.detect-changes.outputs.services != '' }}
    runs-on: ubuntu-latest
    environment: service-deploy-dev
    
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
      fail-fast: false
    
    permissions:
      packages: write
      contents: read
      security-events: write # [ì¶”ê°€ë¨] Trivy ê²°ê³¼ë¥¼ Security íƒ­ì— ì˜¬ë¦¬ê¸° ìœ„í•´ í•„ìš”
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # ì„œë¹„ìŠ¤ë³„ Dockerfile ê²½ë¡œ ë° ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
      - name: Set build configuration
        id: build-config
        run: |
          SERVICE="${{ matrix.service }}"
          
          case "${SERVICE}" in
            "auth-service")
              # Java/Gradle ì„œë¹„ìŠ¤
              DOCKERFILE="services/${SERVICE}/Dockerfile"
              CONTEXT="services/${SERVICE}"
              ;;
            "board-service"|"chat-service"|"noti-service"|"storage-service"|"user-service"|"video-service")
              # Go ì„œë¹„ìŠ¤ë“¤
              DOCKERFILE="services/${SERVICE}/docker/Dockerfile"
              CONTEXT="."
              ;;
            *)
              echo "Error: Unknown service ${SERVICE}"
              exit 1
              ;;
          esac
          
          echo "dockerfile=${DOCKERFILE}" >> $GITHUB_OUTPUT
          echo "context=${CONTEXT}" >> $GITHUB_OUTPUT
          echo "Service: ${SERVICE}"
          echo "Dockerfile: ${DOCKERFILE}"
          echo "Context: ${CONTEXT}"
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,format=short,prefix=${{ needs.detect-changes.outputs.branch }}-
            type=raw,value=${{ needs.detect-changes.outputs.branch }}-latest
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
          labels: |
            org.opencontainers.image.title=${{ matrix.service }}
            org.opencontainers.image.description=Wealist ${{ matrix.service }} service
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      # -------------------------------------------------------------------------
      # [1ë‹¨ê³„] ë³´ì•ˆ ê²€ì‚¬ìš© ìž„ì‹œ ë¹Œë“œ (amd64 Only, No Push)
      # -------------------------------------------------------------------------
      - name: Build for Scan (amd64)
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.build-config.outputs.context }}
          file: ${{ steps.build-config.outputs.dockerfile }}
          platforms: linux/amd64   
          load: true               # ë¡œì»¬ ë„ì»¤ ë°ëª¬ìœ¼ë¡œ ì´ë¯¸ì§€ ë¡œë“œ
          push: false              # GHCRì— í‘¸ì‹œí•˜ì§€ ì•ŠìŒ
          tags: ${{ matrix.service }}:scan-temp
          # ìºì‹œë¥¼ ì €ìž¥í•˜ì—¬ 2ë‹¨ê³„(ì‹¤ì œ ë¹Œë“œ) ì†ë„ í–¥ìƒ
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

      # -------------------------------------------------------------------------
      # [2ë‹¨ê³„] Trivy ìŠ¤ìº” (ê²€ì‚¬ë§Œ ìˆ˜í–‰, ë°°í¬ ì¤‘ë‹¨ ì•ˆí•¨)
      # -------------------------------------------------------------------------
      
      # A. ë¡œê·¸ í™•ì¸ìš© (Table ì¶œë ¥)
      - name: Run Trivy (Log Output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan-temp
          format: 'table'
          # [NOTE] ë‚˜ì¤‘ì— ì·¨ì•½ì  ë°œê²¬ ì‹œ ë°°í¬ë¥¼ ë§‰ìœ¼ë ¤ë©´ ì•„ëž˜ ê°’ì„ '1'ë¡œ ë³€ê²½í•˜ì„¸ìš”.
          exit-code: '0' 
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # B. Security íƒ­ ì—…ë¡œë“œìš© (SARIF ìƒì„±)
      - name: Run Trivy (SARIF Output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan-temp
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: ${{ matrix.service }}

      # -------------------------------------------------------------------------
      # [3ë‹¨ê³„] ì‹¤ì œ ë°°í¬ìš© ë©€í‹° ì•„í‚¤í…ì²˜ ë¹Œë“œ ë° í‘¸ì‹œ
      # -------------------------------------------------------------------------
      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.build-config.outputs.context }}
          file: ${{ steps.build-config.outputs.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 1ë‹¨ê³„ì˜ ìºì‹œë¥¼ ìž¬ì‚¬ìš©
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
      
      - name: Output image info
        run: |
          echo "### ðŸš€ Image Published (Scan Completed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ needs.detect-changes.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64,linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Published Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$${{ steps.meta.outputs.tags }}" >> $$GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  update-gitops-manifests:
    needs: [detect-changes, build-and-push]
    # [ì¤‘ìš”] ì‹¤ì œ ë°°í¬ë¥¼ ë§‰ê¸° ìœ„í•´ í•­ìƒ falseê°€ ë˜ë„ë¡ ì„¤ì •í•¨ (ë‚˜ì¤‘ì— ë°°í¬í•˜ë ¤ë©´ ì´ ì¤„ì„ ì‚­ì œí•˜ì„¸ìš”)
    if: false 
    # ì›ëž˜ ì¡°ê±´ ë°±ì—…:
    # if: |
    #   needs.detect-changes.outputs.services != '[]' && 
    #   needs.detect-changes.outputs.services != '' &&
    #   success() &&
    #   github.event.inputs.skip_gitops != 'true'
    runs-on: ubuntu-latest
    environment: service-deploy-dev
    
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT }}
          fetch-depth: 0
      
      - name: Set environment variables
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA=${SHORT_SHA:0:7}
          NEW_TAG="${{ needs.detect-changes.outputs.branch }}-${SHORT_SHA}"
          
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
      
      - name: Check if k8s-deploy-dev branch exists
        run: |
          if git ls-remote --heads origin k8s-deploy-dev | grep -q k8s-deploy-dev; then
            echo "Branch k8s-deploy-dev exists"
            git fetch origin k8s-deploy-dev
            git checkout k8s-deploy-dev
          else
            echo "Branch k8s-deploy-dev does not exist. Creating it..."
            git checkout -b k8s-deploy-dev
            git push origin k8s-deploy-dev
          fi
      
      - name: Update manifest files
        run: |
          # ì„œë¹„ìŠ¤ë³„ë¡œ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          SERVICES='${{ needs.detect-changes.outputs.services }}'
          
          echo "Updating image tags to: ${NEW_TAG}"
          echo "Services to update: ${SERVICES}"
          
          # ê° ì„œë¹„ìŠ¤ì˜ Application ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          for service in $(echo $SERVICES | jq -r '.[]'); do
            MANIFEST_FILE="k8s/argocd/apps/${service}.yaml"
            
            if [ -f "$MANIFEST_FILE" ]; then
              echo "Updating ${MANIFEST_FILE}"
              
              # ë” ì•ˆì „í•œ sed ëª…ë ¹ì–´ ì‚¬ìš©
              sed -i.bak '/- name: image\.tag/{
                n
                s|value: ".*"|value: "'"${NEW_TAG}"'"|
              }' "$MANIFEST_FILE"
              
              # ë°±ì—… íŒŒì¼ ì‚­ì œ
              rm -f "${MANIFEST_FILE}.bak"
              
              echo "Updated ${service} to tag: ${NEW_TAG}"
              
              # ë³€ê²½ì‚¬í•­ í™•ì¸
              echo "=== Changes in ${MANIFEST_FILE} ==="
              git diff "$MANIFEST_FILE" || true
              echo "=================================="
            else
              echo "Warning: Manifest file not found: ${MANIFEST_FILE}"
              echo "Available files:"
              find k8s -name "*.yaml" -type f | head -10
            fi
          done
      
      - name: Commit and push changes
        run: |
          # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # ë³€ê²½ëœ íŒŒì¼ë“¤ ë³´ê¸°
          echo "Changed files:"
          git diff --name-only
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
          git add .
          git commit -m "ðŸš€ Update image tags for services: ${{ needs.detect-changes.outputs.services }}

          - Branch: ${{ needs.detect-changes.outputs.branch }}
          - SHA: ${{ github.sha }}
          - New tag: ${NEW_TAG}
          
          Updated by: ${{ github.actor }}
          Triggered by: ${{ github.event_name }}"
          
          git push origin k8s-deploy-dev
          
          echo "âœ… Successfully updated manifests in k8s-deploy-dev branch"

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ GitOps Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Updated Services:** ${{ needs.detect-changes.outputs.services }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** k8s-deploy-dev" >> $GITHUB_STEP_SUMMARY
          echo "**New Image Tag:** ${NEW_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ArgoCD will automatically sync these changes.**" >> $GITHUB_STEP_SUMMARY